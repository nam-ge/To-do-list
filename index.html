const todoInput = document.getElementById('todo-input');
const addBtn = document.getElementById('add-btn');
const todoList = document.getElementById('todo-list');

// 알림 소리 재생 함수
function playNotificationSound() {
    try {
        // Web Audio API를 사용한 간단한 "띠링" 소리 생성
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.setValueAtTime(800, audioContext.currentTime); // 800Hz
        oscillator.frequency.setValueAtTime(1000, audioContext.currentTime + 0.1); // 1초 후 1000Hz
        
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.3);
        
    } catch (error) {
        console.log('소리 재생 실패:', error);
        // 대체 방법: 기존 오디오 요소 사용
        const notificationSound = document.getElementById('notification-sound');
        if (notificationSound) {
            notificationSound.currentTime = 0;
            notificationSound.play().catch(e => console.log('대체 소리 재생 실패:', e));
        }
    }
}

// 알림 메시지 표시 함수
function showNotification(message) {
    // 기존 알림이 있다면 제거
    const existingNotification = document.querySelector('.notification');
    if (existingNotification) {
        existingNotification.remove();
    }
    
    const notification = document.createElement('div');
    notification.className = 'notification';
    notification.textContent = message;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #4f8cff;
        color: white;
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 1000;
        font-size: 16px;
        font-weight: 500;
        animation: slideIn 0.3s ease;
    `;
    
    document.body.appendChild(notification);
    
    // 3초 후 알림 제거
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 300);
    }, 3000);
}

function addTodo() {
    const text = todoInput.value.trim();
    if (!text) return;
    
    const li = document.createElement('li');
    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    
    // 반복 알림 타이머 변수
    let notificationTimer;
    let isCompleted = false;
    
    // 반복 알림 함수
    function startRepeatingNotification() {
        if (isCompleted) return; // 완료되었으면 알림 중지
        
        showNotification(`${text} 할일을 하십시오`);
        
        // 15분 후 다시 알림 (15분 = 900,000밀리초)
        notificationTimer = setTimeout(startRepeatingNotification, 900000);
    }
    
    checkbox.addEventListener('change', function() {
        if (checkbox.checked) {
            todoText.classList.add('completed');
            isCompleted = true;
            // 체크하면 알림 타이머 취소
            if (notificationTimer) {
                clearTimeout(notificationTimer);
            }
        } else {
            todoText.classList.remove('completed');
            isCompleted = false;
            // 체크 해제하면 다시 알림 시작
            startRepeatingNotification();
        }
    });
    
    const todoText = document.createElement('span');
    todoText.className = 'todo-text';
    todoText.textContent = text;
    
    const deleteBtn = document.createElement('button');
    deleteBtn.className = 'delete-btn';
    deleteBtn.innerHTML = '🗑️';
    deleteBtn.onclick = function() {
        // 삭제할 때도 알림 타이머 취소
        isCompleted = true;
        if (notificationTimer) {
            clearTimeout(notificationTimer);
        }
        todoList.removeChild(li);
    };
    
    li.appendChild(checkbox);
    li.appendChild(todoText);
    li.appendChild(deleteBtn);
    todoList.appendChild(li);
    todoInput.value = '';
    todoInput.focus();
    
    // 15분 후에 첫 번째 알림 시작 (15분 = 900,000밀리초)
    notificationTimer = setTimeout(startRepeatingNotification, 900000);
}

addBtn.addEventListener('click', addTodo);
todoInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') addTodo();
}); 
